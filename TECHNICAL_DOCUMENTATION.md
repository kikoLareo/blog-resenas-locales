# üìö Documentaci√≥n T√©cnica - Blog Rese√±as Locales

## üèóÔ∏è Arquitectura General

### Stack Tecnol√≥gico

- **Framework**: Next.js 15.1.0 (App Router)
- **CMS**: Sanity v4.4.1
- **Base de Datos**: Prisma (para usuarios y autenticaci√≥n)
- **Autenticaci√≥n**: NextAuth.js
- **Estilos**: Tailwind CSS
- **TypeScript**: Tipado fuerte en toda la aplicaci√≥n
- **Testing**: Vitest + Playwright
- **Deployment**: Vercel

---

## üóÇÔ∏è Estructura de Carpetas

```
blog-resenas-locales/
‚îú‚îÄ‚îÄ app/                          # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/                   # Rutas de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ (marketing)/              # P√°ginas de marketing
‚îÇ   ‚îú‚îÄ‚îÄ (public)/                 # P√°ginas p√∫blicas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx              # Homepage con hero y secciones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [citySlug]/           # P√°ginas de ciudad
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx          # Lista de venues por ciudad
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [venueSlug]/      # Detalle de venue
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx      # P√°gina de venue
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ review/[reviewSlug]/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx  # Detalle de rese√±a
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ categorias/[slug]/    # P√°ginas de categor√≠as
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/                # Admin Dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ venues/               # Gesti√≥n de venues
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reviews/              # Gesti√≥n de rese√±as
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cities/               # Gesti√≥n de ciudades
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ categories/           # Gesti√≥n de categor√≠as
‚îÇ   ‚îú‚îÄ‚îÄ api/                      # API Routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/                # Endpoints admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                 # NextAuth endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ revalidate/           # Cache revalidation
‚îÇ   ‚îî‚îÄ‚îÄ studio/                   # Sanity Studio
‚îú‚îÄ‚îÄ components/                   # Componentes React
‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # Componentes UI base
‚îÇ   ‚îî‚îÄ‚îÄ dashboard/                # Componentes del dashboard
‚îú‚îÄ‚îÄ lib/                          # Utilidades y configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ sanity.ts                 # Cliente Sanity p√∫blico
‚îÇ   ‚îú‚îÄ‚îÄ sanity.client.ts          # Cliente Sanity avanzado
‚îÇ   ‚îú‚îÄ‚îÄ admin-sanity.ts           # Cliente Sanity admin
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts                   # Configuraci√≥n NextAuth
‚îú‚îÄ‚îÄ sanity/                       # Configuraci√≥n Sanity
‚îÇ   ‚îú‚îÄ‚îÄ schemas/                  # Schemas de contenido
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ venue.ts              # Schema de locales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ review.ts             # Schema de rese√±as
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ city.ts               # Schema de ciudades
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ category.ts           # Schema de categor√≠as
‚îÇ   ‚îú‚îÄ‚îÄ desk/                     # Estructura del Studio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ structure.ts          # Organizaci√≥n del contenido
‚îÇ   ‚îî‚îÄ‚îÄ env.ts                    # Variables de entorno Sanity
‚îú‚îÄ‚îÄ prisma/                       # Base de datos
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma             # Schema Prisma (usuarios)
‚îî‚îÄ‚îÄ scripts/                      # Scripts de utilidad
    ‚îú‚îÄ‚îÄ check-sanity-data.ts      # Verificar datos
    ‚îî‚îÄ‚îÄ debug-city-field.ts       # Debug de campos
```

---

## üîå Comunicaci√≥n con Sanity

### Clientes Sanity

La aplicaci√≥n utiliza **3 clientes diferentes** de Sanity seg√∫n el contexto:

#### 1. **Cliente P√∫blico** (`lib/sanity.ts`)
```typescript
import { createClient } from '@sanity/client'

export const sanityClient = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET,
  apiVersion: '2024-01-01',
  useCdn: true, // Usa CDN para mejor rendimiento
})
```

**Uso**: Consultas p√∫blicas (p√°ginas de venue, rese√±as, listados)

#### 2. **Cliente Admin** (`lib/admin-sanity.ts`)
```typescript
export const adminSanityClient = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET,
  apiVersion: '2024-01-01',
  useCdn: false, // Sin CDN para datos frescos
  token: process.env.SANITY_API_TOKEN, // Token con permisos
})
```

**Uso**: Dashboard admin, operaciones CRUD

#### 3. **Cliente Write** (`lib/admin-sanity.ts`)
```typescript
export const adminSanityWriteClient = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET,
  apiVersion: '2024-01-01',
  useCdn: false,
  token: process.env.SANITY_API_TOKEN,
  ignoreBrowserTokenWarning: true, // Para escritura
})
```

**Uso**: Crear, actualizar y eliminar documentos

### Variables de Entorno Sanity

```env
# P√∫blicas (accesibles en cliente)
NEXT_PUBLIC_SANITY_PROJECT_ID=xaenlpyp
NEXT_PUBLIC_SANITY_DATASET=production
NEXT_PUBLIC_SANITY_API_VERSION=2024-01-01

# Privadas (solo servidor)
SANITY_API_TOKEN=sk_xxxxx  # Token con permisos de escritura
SANITY_AUTH_TOKEN=sk_xxxxx # Alias del token
```

### Queries GROQ Comunes

#### Obtener Venues con Ciudad
```groq
*[_type == "venue" && defined(city._ref)] {
  _id,
  title,
  slug,
  description,
  address,
  phone,
  website,
  priceRange,
  "citySlug": city->slug.current,
  "cityTitle": city->title,
  city-> {
    _id,
    title,
    slug
  },
  categories[]-> {
    _id,
    title
  }
}
```

#### Obtener Rese√±as con Venue y Ciudad
```groq
*[_type == "review"] {
  _id,
  title,
  slug,
  content,
  ratings {
    food,
    service,
    ambience,
    value
  },
  "venueSlug": venue->slug.current,
  "venueTitle": venue->title,
  "citySlug": venue->city->slug.current,
  venue-> {
    _id,
    title,
    slug,
    city-> {
      _id,
      title,
      slug
    }
  }
}
```

#### Filtrar por Ciudad
```groq
*[_type == "venue" && city->slug.current == $citySlug] | order(title asc) {
  _id,
  title,
  slug,
  description,
  priceRange
}
```

---

## üìä Schemas de Sanity

### Venue (Local)
```typescript
{
  name: 'venue',
  title: 'Local/Venue',
  type: 'document',
  fields: [
    { name: 'title', type: 'string', required: true },
    { name: 'slug', type: 'slug', required: true },
    { name: 'city', type: 'reference', to: [{ type: 'city' }], required: true },
    { name: 'description', type: 'text' },
    { name: 'address', type: 'string', required: true },
    { name: 'phone', type: 'string' },
    { name: 'website', type: 'url' },
    { name: 'priceRange', type: 'string' }, // ‚Ç¨, ‚Ç¨‚Ç¨, ‚Ç¨‚Ç¨‚Ç¨, ‚Ç¨‚Ç¨‚Ç¨‚Ç¨
    { name: 'categories', type: 'array', of: [{ type: 'reference', to: [{ type: 'category' }] }] },
    { name: 'images', type: 'array', of: [{ type: 'image' }] }
  ]
}
```

### Review (Rese√±a)
```typescript
{
  name: 'review',
  title: 'Rese√±a',
  type: 'document',
  fields: [
    { name: 'title', type: 'string', required: true },
    { name: 'slug', type: 'slug', required: true },
    { name: 'venue', type: 'reference', to: [{ type: 'venue' }], required: true },
    { name: 'content', type: 'array', of: [{ type: 'block' }] },
    { 
      name: 'ratings', 
      type: 'object',
      fields: [
        { name: 'food', type: 'number', min: 1, max: 5 },
        { name: 'service', type: 'number', min: 1, max: 5 },
        { name: 'ambience', type: 'number', min: 1, max: 5 },
        { name: 'value', type: 'number', min: 1, max: 5 }
      ]
    },
    { name: 'visitDate', type: 'date' },
    { name: 'featured', type: 'boolean' }
  ]
}
```

### City (Ciudad)
```typescript
{
  name: 'city',
  title: 'Ciudad',
  type: 'document',
  fields: [
    { name: 'title', type: 'string', required: true }, // Nombre de la ciudad
    { name: 'slug', type: 'slug', required: true },
    { name: 'region', type: 'string' }, // Regi√≥n/Provincia
    { name: 'country', type: 'string', default: 'Espa√±a' },
    { name: 'description', type: 'text' },
    { name: 'coordinates', type: 'geopoint' },
    { name: 'isActive', type: 'boolean', default: true }
  ]
}
```

### Category (Categor√≠a)
```typescript
{
  name: 'category',
  title: 'Categor√≠a',
  type: 'document',
  fields: [
    { name: 'title', type: 'string', required: true },
    { name: 'slug', type: 'slug', required: true },
    { name: 'description', type: 'text' },
    { name: 'featured', type: 'boolean' }
  ]
}
```

---

## üåê Estructura de URLs

### Patr√≥n de URLs SEO-Optimizado

```
/                                    ‚Üí Homepage
/{citySlug}                          ‚Üí Lista de venues por ciudad
/{citySlug}/{venueSlug}              ‚Üí Detalle de venue
/{citySlug}/{venueSlug}/review/{reviewSlug} ‚Üí Detalle de rese√±a
/categorias/{categorySlug}           ‚Üí Venues por categor√≠a
```

### Ejemplos Reales
```
/                                    ‚Üí Homepage
/a-coruna                            ‚Üí Venues de A Coru√±a
/a-coruna/sushi-ikigai               ‚Üí Detalle de Sushi Ikigai
/a-coruna/sushi-ikigai/review/omakase-barcelona ‚Üí Rese√±a espec√≠fica
/categorias/sushi                    ‚Üí Todos los sushi
```

### Generaci√≥n Din√°mica de URLs

En el homepage (`app/(public)/page.tsx`):
```typescript
// URL robusta con validaciones
const venueUrl = citySlug && venueSlug 
  ? `/${citySlug}/${venueSlug}`
  : venueSlug 
    ? `/a-coruna/${venueSlug}` // Fallback a A Coru√±a
    : '#';
```

---

## üîê Autenticaci√≥n y Autorizaci√≥n

### Sistema de Usuarios

- **Base de datos**: Prisma + PostgreSQL
- **Autenticaci√≥n**: NextAuth.js
- **Roles**: Admin, Editor, User

### Schema Prisma
```prisma
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String
  role          String    @default("user")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
```

### Protecci√≥n de Rutas

```typescript
// En API Routes
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';

export async function GET() {
  const session = await getServerSession(authOptions);
  
  if (!session?.user) {
    return NextResponse.json({ error: 'No autorizado' }, { status: 401 });
  }
  
  // L√≥gica protegida
}
```

---

## üì° API Routes

### Endpoints Admin

#### Venues
```
GET    /api/admin/venues           ‚Üí Listar todos los venues
GET    /api/admin/venues/[id]      ‚Üí Obtener venue por ID
POST   /api/admin/venues           ‚Üí Crear nuevo venue
PUT    /api/admin/venues/[id]      ‚Üí Actualizar venue
DELETE /api/admin/venues/[id]      ‚Üí Eliminar venue
```

#### Reviews
```
GET    /api/admin/reviews          ‚Üí Listar todas las rese√±as
GET    /api/admin/reviews/[id]     ‚Üí Obtener rese√±a por ID
POST   /api/admin/reviews          ‚Üí Crear nueva rese√±a
PUT    /api/admin/reviews/[id]     ‚Üí Actualizar rese√±a
DELETE /api/admin/reviews/[id]     ‚Üí Eliminar rese√±a
```

#### Cities
```
GET    /api/admin/cities           ‚Üí Listar todas las ciudades
GET    /api/admin/cities/[id]      ‚Üí Obtener ciudad por ID
POST   /api/admin/cities           ‚Üí Crear nueva ciudad
PUT    /api/admin/cities/[id]      ‚Üí Actualizar ciudad
DELETE /api/admin/cities/[id]     ‚Üí Eliminar ciudad
```

### Ejemplo de Actualizaci√≥n de Venue

```typescript
// PUT /api/admin/venues/[id]
export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const session = await getServerSession(authOptions);
  
  if (!session?.user) {
    return NextResponse.json({ error: 'No autorizado' }, { status: 401 });
  }

  const data = await request.json();
  
  // Actualizar en Sanity
  const updated = await adminSanityWriteClient
    .patch(params.id)
    .set({
      title: data.title,
      slug: data.slug,
      description: data.description,
      address: data.address,
      phone: data.phone,
      website: data.website,
      priceRange: data.priceRange,
      city: {
        _type: 'reference',
        _ref: data.city
      },
      categories: data.categories.map((id: string) => ({
        _type: 'reference',
        _ref: id
      }))
    })
    .commit();

  // Revalidar cach√©
  revalidateTag('venues');
  
  return NextResponse.json(updated);
}
```

---

## üé® Dashboard Admin

### Estructura del Dashboard

```
/dashboard
‚îú‚îÄ‚îÄ /                        ‚Üí Vista general
‚îú‚îÄ‚îÄ /venues                  ‚Üí Gesti√≥n de locales
‚îÇ   ‚îú‚îÄ‚îÄ /                    ‚Üí Lista de venues
‚îÇ   ‚îú‚îÄ‚îÄ /new                 ‚Üí Crear venue
‚îÇ   ‚îî‚îÄ‚îÄ /[id]                ‚Üí Editar venue (VenueDetailClient)
‚îú‚îÄ‚îÄ /reviews                 ‚Üí Gesti√≥n de rese√±as
‚îú‚îÄ‚îÄ /cities                  ‚Üí Gesti√≥n de ciudades
‚îî‚îÄ‚îÄ /categories              ‚Üí Gesti√≥n de categor√≠as
```

### Componente VenueDetailClient

Este componente permite **editar venues** desde el dashboard:

**Caracter√≠sticas**:
- ‚úÖ Editar informaci√≥n b√°sica (nombre, slug, descripci√≥n)
- ‚úÖ **Selector de ciudad** (nuevo campo agregado)
- ‚úÖ Editar contacto (direcci√≥n, tel√©fono, web)
- ‚úÖ Cambiar rango de precios
- ‚úÖ Gesti√≥n de im√°genes
- ‚úÖ Ver rese√±as asociadas

**Flujo de edici√≥n**:
1. Usuario abre modal de edici√≥n
2. Se cargan las ciudades disponibles desde `/api/admin/cities`
3. Usuario modifica campos (incluida la ciudad)
4. Al guardar, se env√≠a PUT a `/api/admin/venues/[id]`
5. Se actualiza en Sanity y se revalida el cach√©
6. Se recarga la p√°gina para mostrar cambios

---

## üöÄ Deployment y Cache

### Vercel Deployment

```json
// vercel.json
{
  "buildCommand": "npm run build",
  "framework": "nextjs",
  "regions": ["iad1"],
  "functions": {
    "app/api/sitemap/route.ts": { "maxDuration": 30 },
    "app/api/revalidate/route.ts": { "maxDuration": 10 }
  }
}
```

### Revalidaci√≥n de Cache

#### On-Demand Revalidation
```typescript
import { revalidateTag, revalidatePath } from 'next/cache';

// Revalidar por tag
revalidateTag('venues');
revalidateTag('reviews');

// Revalidar path espec√≠fico
revalidatePath('/a-coruna');
revalidatePath('/a-coruna/sushi-ikigai');
```

#### ISR (Incremental Static Regeneration)
```typescript
// En page.tsx
export const revalidate = 3600; // Revalidar cada hora
```

---

## üõ†Ô∏è Scripts de Utilidad

### Verificar Datos de Sanity
```bash
npx tsx scripts/check-sanity-data.ts
```

**Salida**:
- Cuenta de featured items, reviews, venues
- URLs generadas y su validez
- Estado de ciudades y categor√≠as

### Debug de Campo Ciudad
```bash
npx tsx scripts/debug-city-field.ts
```

**Salida**:
- Lista de ciudades disponibles
- Venues y sus ciudades asignadas
- Diagn√≥stico de problemas de referencia

### Crear Usuario Admin
```bash
npm run create-admin
```

---

## üêõ Debugging Common Issues

### Ciudad no aparece en modal de edici√≥n

**Problema**: El campo ciudad no se muestra en VenueDetailClient
**Causa**: No se agreg√≥ el selector de ciudad al modal
**Soluci√≥n**: Ya est√° implementado en l√≠neas 492-521 de `VenueDetailClient.tsx`

### URLs sin prefijo de ciudad

**Problema**: URLs como `/cal-pep-barcelona` en lugar de `/barcelona/cal-pep-barcelona`
**Causa**: Venues sin ciudad asignada o ciudad sin slug
**Soluci√≥n**: 
1. Verificar en Sanity que el venue tiene ciudad
2. Verificar que la ciudad tiene slug v√°lido
3. Usar script de debug: `npx tsx scripts/debug-city-field.ts`

### Datos no se actualizan

**Problema**: Cambios en Sanity no se reflejan en el sitio
**Causa**: Cache de Next.js o Sanity CDN
**Soluciones**:
- Revalidar tag: `revalidateTag('venues')`
- Usar `useCdn: false` en adminSanityClient
- Esperar tiempo de revalidaci√≥n (si ISR est√° configurado)

---

## üìù Buenas Pr√°cticas

### 1. **Siempre usar el cliente correcto**
- `sanityClient` ‚Üí P√°ginas p√∫blicas
- `adminSanityClient` ‚Üí Dashboard (lectura)
- `adminSanityWriteClient` ‚Üí Operaciones de escritura

### 2. **Validar referencias**
```typescript
// Siempre verificar que la referencia existe
const citySlug = venue?.city?.slug?.current;
if (!citySlug) {
  return fallbackUrl; // O manejar el error
}
```

### 3. **Revalidar despu√©s de cambios**
```typescript
// Despu√©s de crear/actualizar/eliminar
revalidateTag('venues');
revalidatePath(`/${citySlug}/${venueSlug}`);
```

### 4. **Tipado fuerte**
```typescript
interface Venue {
  _id: string;
  title: string;
  slug: { current: string };
  city: {
    _id: string;
    title: string;
    slug: { current: string };
  };
}
```

### 5. **Manejo de errores**
```typescript
try {
  const data = await sanityClient.fetch(query);
  return data;
} catch (error) {
  console.error('Error fetching data:', error);
  return null; // O throw error seg√∫n contexto
}
```

---

## üìö Recursos y Referencias

### Documentaci√≥n
- [Next.js 15 Docs](https://nextjs.org/docs)
- [Sanity v4 Docs](https://www.sanity.io/docs)
- [GROQ Query Language](https://www.sanity.io/docs/groq)
- [NextAuth.js](https://next-auth.js.org/)
- [Prisma](https://www.prisma.io/docs)

### Comandos √ötiles
```bash
# Desarrollo
npm run dev                    # Next.js dev server
npm run studio                 # Sanity Studio

# Build
npm run build                  # Build producci√≥n
npm run start                  # Servidor producci√≥n

# Testing
npm run test                   # Vitest
npm run test:e2e              # Playwright E2E

# Utilidades
npm run type-check            # TypeScript check
npm run lint                  # ESLint
npx tsx scripts/[script].ts   # Ejecutar scripts
```

---

## üéØ Datos Clave del Proyecto

### Ciudades Principales
- **A Coru√±a** (90% del contenido) - slug: `a-coruna`
- Barcelona - slug: `barcelona`
- Madrid - slug: `madrid`
- Valencia - slug: `valencia`
- Bilbao - slug: `bilbao`
- Sevilla - slug: `sevilla`

### Sanity Project
- **Project ID**: `xaenlpyp`
- **Dataset**: `production`
- **API Version**: `2024-01-01`

### Patrones de URL SEO
```
/{ciudad}/{local}                      ‚Üí Detalle de local
/{ciudad}/{local}/review/{rese√±a}      ‚Üí Detalle de rese√±a
```

---

## üîÑ Flujo de Datos Completo

```
Usuario ‚Üí Next.js App Router
    ‚Üì
P√°gina P√∫blica (ISR/SSR)
    ‚Üì
sanityClient.fetch() ‚Üí Sanity CMS
    ‚Üì
Renderizar con datos
    ‚Üì
Cache (ISR) ‚Üí Servir desde cache


Admin ‚Üí Dashboard
    ‚Üì
VenueDetailClient (React)
    ‚Üì
Editar datos ‚Üí POST/PUT /api/admin/venues
    ‚Üì
adminSanityWriteClient ‚Üí Sanity CMS
    ‚Üì
revalidateTag() ‚Üí Limpiar cache
    ‚Üì
Actualizaci√≥n completa
```

---

**√öltima actualizaci√≥n**: Octubre 2025
**Versi√≥n**: 1.0.0
**Mantenedor**: Kiko Lareo Garc√≠a
